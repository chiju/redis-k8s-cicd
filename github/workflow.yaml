name: Deploy Redis with Zero Downtime

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2  # Adjust region as needed

    - name: Setup kubectl
      uses: actions-hub/kubectl@master
      with:
        version: 'v1.21.0'  # Match your Kubernetes version

    - name: Install Helm
      uses: azure/setup-helm@v1

    - name: Add Bitnami Helm repo
      run: |
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo update

    - name: Deploy Redis with Zero Downtime
      run: |
        helm upgrade --install my-redis bitnami/redis -f values.yaml --wait --atomic
      env:
        KUBECONFIG: ${{ secrets.KUBECONFIG }}  # Add your kubeconfig to GitHub secrets

    - name: Check Deployment Status
      run: |
        kubectl rollout status statefulset/my-redis-master
        kubectl rollout status statefulset/my-redis-replicas